<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@3.8.3/dist/ol-layerswitcher.css" />
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poiret&#43;One&amp;display=swap&amp;subset=latin-ext" />
    <link rel="stylesheet" href="https://unpkg.com/@tabler/icons@latest/iconfont/tabler-icons.min.css" />
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://unpkg.com/ol-layerswitcher@3.8.3"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <title>FlyMaps</title>
  </head>
  <body>
      <div id="app" x-data x-init="fetch('/user').then(r => r.text()).then(u => { $store.logged.user = u; })">
        <div id="sidebarData" x-ref="data" x-data="{ editorOpen: true, mode: 'Draw', modes: [
            'Draw', 'Edit', 'User' ], icons: [ 'tools', 'tool', 'user' ] }"
            x-init="$watch('mode', m => { if (modes.indexOf(m) != 0) { $dispatch('cursor'); } })"
            @mode.window="$store.mode = $event.detail">
            <div id="open" x-show="!editorOpen">
                <button x-on:click="editorOpen = !editorOpen; updateMapSize()">&gt;</button></div>
            <div id="edit" x-show="editorOpen" class="cell cell-edit edit">
                <div id="menu">
                    <div>
                        <button id="close" title="Close sidebar" @click="editorOpen = false; updateMapSize()">Hide</button>
                        <ul>
                            <template x-for="(m,i) in modes">
                                <button @click="$store.mode = m" :title="m" :class="'ti ti-' +
                                 icons[i] + ' ' + ($store.mode == m ?
                                        'active' : '')"></button>
                            </template>
                        </ul>
                        <button x-show="$store.logged.user && $store.logged.user.length"
                              @click="fetch('/logout').then(r => r.text()).then(t => {
                                       $store.logged.status = 'Logged out.';
                              $store.logged.user = ''; })"
                            title="Click to log out" class="logout" x-text="'User: ' + $store.logged.user"></span>
                    </div>
                    <img id="fclogo" src="https://flyingcaravans.pl/images/fcg.gif" />
                </div>
                <div id="position">Cursor: </div>
                <div id="user" x-show="$store.mode == 'User'">
                    <form id="login-form" x-data="{ user: '', passwd: '', mail: '' }"
                        x-show="!$store.logged.user || $store.logged.user.length == 0"
                        x-on:submit.prevent="console.log(user, passwd, mail)">
                        <label for="form-user">User<input x-model="user" name="form-user" /></label>
                        <label for="form-passwd">Pass<input x-model="passwd"
                            type="password" name="form-passwd" /></label>
                        <label for="form-mail">Mail<input x-model="mail"
                            type="email" name="form-mail" /></label>
                        <input type="submit" value="&rsaquo;" title="Login" id="login-button"
                            @click.prevent="$store.logged.status = ''; var fd = new FormData();
                                fd.append('user', user); fd.append('passwd', passwd);
                                fetch('/login', { method: 'POST', body: fd })
                                .then(r => r.text().then(u => {
                                        if (r.status > 200) { $store.logged.status = 'Wrong user or password.'; }
                                        else { $store.logged.user = u; $store.logged.status = 'Logged as ' + u + '.'; }
                                    }))" />
                    </form>
                    <span x-text="$store.logged.status"></span>
                </div>
                <div id="editView" x-show="$store.mode == 'Edit'">
                    <div id="editList" x-data="setupEdit()" x-init="unit = units[0]">
                        <template x-for="(f,i) in $store.selected">
                            <div><template x-if="!f.empty"><div class="gr">
                                <div class="gc editHeader">
                                    <button x-show="f.icon" :class="'ti ti-' +
                                        f.icon" :title="f.type" @click="centerView(f)"></button>
                                    <button x-text="f.name || f.type"
                                            class="editName" title="Rename"
                                        @click="f.name = prompt('New name') || f.name; selectFeatures()"></button>
                                </div>
                                <small x-show="f.name" x-text="f.type"></small>
                                <span x-html="f.info"></span><br />
                                <small x-html="niceInfo(f)"></small><br />
                                <ul id="tools">
                                    <template x-for="(tool,i) in tools" :key="i">
                                        <button class="tool"
                                            :class="className(tool)"
                                            @click="tool.action(tool,f,$el);
                                                $dispatch('update')"
                                            x-text="tool.icon ? '' : tool.symbol"
                                            :title="tool.tooltip || tool.value"
                                        ></button>
                                    </template>
                                </ul>
                                <label for="fill" class="gc props prop-color">
                                    <span class="propLabel">Color</span>
                                    <input name="fill" x-model="f.color"
                                        @input="updateFeature(f)"
                                        type="color" />
                                </label>
                                <template x-for="(l,i) in fields" :key="i">
                                    <div>
                                        <template x-for="(p,j) in l.props" :key="j">
                                            <div>
                                                <label :for="p" x-show="f.type ==
                                                    l.type" class="gc props">
                                                    <span class="propLabel" x-text="p"></span>
                                                    <input :name="p" x-model="f[p]"
                                                        @input="updateFeature(f, $event)" />
                                                    <button x-show="f.units[p]"
                                                        x-text="f.units[p]"
                                                        @click = "arrows = { f: f, p: p }"
                                                        :class="{ active: arrows.f == f && arrows.p == p }"
                                                        class="propUnits"></button>
                                                </label>
                                                <ul x-show="arrows.f == f && arrows.p == p" class="gc">
                                                    <template x-for="(v,vi) in [ -100, -10, -1, 1, 10, 100 ]">
                                                        <button x-text="v"
                                                            @click="f[p] = f[p] + (v * (unit || units[0]).v);
                                                                updateFeature(f)"
                                                            ></button>
                                                    </template>
                                                    <template x-for="(u,ui) in units">
                                                        <button :class="{ active: unit == u }"
                                                            @click="unit = u " x-text="u.u"></button>
                                                    </template>
                                                </ul>
                                            </div>
                                        </template>
                                        <template x-for="(c,j) in f.coords" :key="j">
                                            <div class="propmarg">
                                                <template x-for="(d,k) in [ 'x', 'y' ]">
                                                        <label :for="d + j" class="gc props">
                                                            <span class="propLabel" x-text="d + (j + 1)"></span>
                                                            <input :name="d + j" x-model="c[k]"
                                                                @input="updateFeature(f, $event)" />
                                                            <button class="ti ti-arrows-maximize"
                                                                :class="(arrows.f == f &&
                                                                    arrows.i == j) ?  'tool-active' : ''"
                                                                    @click="arrows = { f: f, i: j }"></button>
                                                        </label>
                                                </template>
                                                <div x-show="arrows.f == f && arrows.i == j" class="arrows">
                                                    <template x-for="(ad,ai) in [ 'l', 'u', 'd', 'r' ]">
                                                    <button :class="'ti ti-' + arrowIcons[ad] + ' a' + ad"
                                                        @click="moveCoord(f, j, ad, mag, unit)"></button>
                                                    </template>
                                                    <div class="arrow-tools at gr">
                                                        <template x-for="(m,mi) in [ 1, 10, 100 ]">
                                                            <button
                                                                :class="{ active: mag == m }"
                                                                @click="mag = m "
                                                                x-text="m"></button>
                                                        </template>
                                                        <div class="arrow-units gc">
                                                            <template
                                                                x-for="(u,ui) in units">
                                                                <button
                                                                    :class="{ active: unit == u }"
                                                                    @click="unit = u "
                                                                    x-text="u.u"></button>
                                                            </template>
                                                        </div>
                                                    </div>
                                                    <button class="ti ti-x ac" @click="arrows = {}"></button>
                                                    <button @click="centerView(f)" title="Center view"
                                                        class="ti ti-focus-2 af"></button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div></template></div>
                        </template>
                        <div x-show="$store.selected.length == 0"
                            class="noSelection"><span>Nothing selected.</span></div>
                    </div>
                </div>
                <div id="draw" x-show="$store.mode == 'Draw'" x-data="setupTools()" x-init="current = tools[0]"
                        @cursor.window="current = tools[0]; setTool(tools[0])">
                    <ul class="tools-main">
                        <template x-for="(tool,i) in tools" :key="i">
                            <button class="tool" :class="(tool == current ?
                             'tool-active ' : '') + (tool.icon ? 'ti ti-' +
                             tool.icon : '')" @click="setTool(tool); current =
                              tool.hide ? current : tool" x-text="tool.icon ? '' : tool.symbol"
                                :title="tool.tooltip || tool.value" x-show="!tool.hide || tool.value == current.show">#</button>
                        </template>
                    </ul>
                    <ul class="tools-main">
                        <template x-for="(tool,i) in toolsSec" :key="i">
                            <button class="tool" :class="(tool == current ?
                             'tool-active ' : '') + (tool.icon ? 'ti ti-' +
                             tool.icon : '')" @click="setTool(tool); current =
                              tool.hide ? current : tool" x-text="tool.icon ? '' : tool.symbol"
                                :title="tool.tooltip || tool.value" x-show="!tool.hide || tool.value == current.show">#</button>
                        </template>
                    </ul>
                    <div id="featuresList" x-data="{ features: [], remove: {} }">
                        <template x-for="f in features" :key="f.ol_uid">
                            <div @click="selectFeature(f)" class="feature"
                                :class="{ 'active': $store.selected.indexOf(f) >= 0 }">
                                <i x-show="f.icon" :class="'ti ti-' + f.icon"></i>
                                <div>
                                    <span x-text="f.name || f.type" :title="f.type"></span><br />
                                    <small x-html="f.info" :title="niceInfo(f)"></small></div>
                                <button @click="centerView(f)" title="Center view" class="ti ti-focus-2"></button>
                                <button x-show="remove == f" @click="removeFeature(f)" class="ti
                                 ti-check"></button>

                                <button x-show="remove == f" @click="remove = {}" class="ti ti-x"></button>
                                <button x-show="remove != f" title="Edit this object"
                                    @click="selectFeature(f); $dispatch('mode', 'Edit')"
                                    class="ti ti-tool"></button>
                                <button x-show="remove != f" @click="remove = f" title="Delete" class="ti ti-trash"></button>
                            </div>
                        </template>
                        <div x-show="features.length == 0" class="noFeatures"><span>No drawings.</span></div>
                    </div>
                </div>
                <span id="copy">&copy; 2021, Flying Caravans.<br /><span>Nieuprawniony dostęp będzie wiązał się z użyciem siły.  Nadmiernej.</span></span>
            </div>
        </div>
        <div id="map" class="cell cell-map map"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@ryangjchandler/spruce@2.x.x/dist/spruce.umd.js"></script>
    <script type="text/javascript" src="/static/script.js"></script>
  </body>
</html>
